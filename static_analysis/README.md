# PyTorch LLM 分布式训练静态分析框架

本框架集成了多种静态分析工具，用于在不运行完整训练的情况下验证PyTorch LLM分布式训练代码的正确性，特别关注MLA（Multi-Latent Attention）和MOE（Mixture of Experts）组件。

## 目录

1. [框架概述](#框架概述)
2. [工具组件](#工具组件)
3. [安装指南](#安装指南)
4. [使用方法](#使用方法)
5. [自动修复功能](#自动修复功能)
6. [常见错误模式](#常见错误模式)
7. [LLM集成](#llm集成)
8. [持续改进](#持续改进)

## 框架概述

本框架旨在通过静态分析和半形式化验证方法，在不依赖完整GPU训练的情况下验证PyTorch LLM分布式训练代码的正确性。框架集成了以下核心功能：

- **张量形状分析**：使用PyTea检测潜在的张量形状不匹配错误
- **类型检查增强**：使用TorchTyping为张量添加形状和维度约束
- **常见错误模式检测**：使用PyAssist检测常见的PyTorch编程错误
- **分布式同步验证**：检测潜在的分布式训练同步问题
- **符号执行**：对关键代码路径进行符号执行分析
- **自动修复**：自动修复常见的代码问题，提高开发效率

通过这些工具的组合，我们可以在代码编写阶段就发现并修复大部分问题，显著降低在GPU上调试的时间和成本。

## 工具组件

### 1. PyTea - 张量形状分析

[PyTea](https://github.com/ropas/pytea)是一个专门针对PyTorch代码的静态分析器，可以检测潜在的张量形状不匹配错误。它通过符号执行技术分析代码中可能的执行路径，并验证每条路径上的张量操作是否存在形状兼容性问题。

### 2. TorchTyping - 张量类型增强

[TorchTyping](https://github.com/patrick-kidger/torchtyping)提供了增强的类型注解功能，允许在类型系统中指定张量的形状、维度和数据类型。这使得我们可以在静态检查阶段捕获更多的类型相关错误。

### 3. PyAssist - 模式检测

PyAssist是一个基于模式的静态分析工具，可以检测常见的PyTorch编程错误，如未正确设置设备、梯度累积问题、数据预处理遗漏等。

### 4. 分布式同步验证

我们开发的分布式同步验证工具可以分析分布式训练代码中的通信模式，检测潜在的死锁、不同步和资源竞争问题。

### 5. 符号执行工具

基于CrossHair的符号执行工具，可以对关键代码路径进行深入分析，验证在各种输入条件下的行为是否符合预期。

### 6. 自动修复工具

我们的自动修复工具可以自动修复静态分析工具检测到的常见问题，如类型注解错误、张量形状检查缺失、常见的代码模式问题等。

## 安装指南

请参考[安装脚本](./install.sh)安装所有必要的依赖和工具。

## 使用方法

详细的使用方法请参考[使用指南](./USAGE.md)。

## 自动修复功能

本框架提供了自动修复功能，可以自动修复静态分析工具检测到的常见问题。详细的使用方法请参考[自动修复指南](./AUTOFIX_GUIDE.md)。

## 常见错误模式

我们总结了在LLM分布式训练中常见的错误模式，请参考[错误模式文档](./ERROR_PATTERNS.md)。

## LLM集成

本框架专门设计了LLM友好的接口，使得LLM可以直接使用静态分析工具分析代码并生成报告。详细的使用方法请参考[LLM使用指南](./LLM_USAGE_GUIDE.md)。

## 持续改进

本框架采用迭代式改进方法，通过不断收集和分析实际项目中的错误案例，持续优化和扩展静态分析规则和检测能力。
